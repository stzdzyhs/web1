<!DOCTYPE HTML>
<html>
<head>
<title>Web Client</title>

<style>
html,body {
    height:100%;
    margin:0;
    padding:0
}

#dHead {
    height:100px;
/*     line-height:100px; */
    background:#690;
    width:100%;
    position:absolute;
/*     z-index:5; */
    top:0;
    box-sizing:border-box;
    padding:15px 35px 10px 15px;
/*     text-align:center; */
}
#dBody {
/*     background:#FC0; */
    width:100%;
	overflow:auto; 
/*     overflow:hide; */
/*     z-index:10; */
    position:absolute;
    top:100px;
    bottom:100px;
}
.mycontent {
    padding:20px;
    border:0px solid blue;
}
#dFoot {
    height:100px;
/*     line-height:100px; */
/*     background:red; */
    width:100%;
/*     z-index:200; */
    position:absolute;
    bottom:0;
/*     text-align:center; */
}

.left { 
	float:left; 
	width:300px;
 	height:100%;
	background:#eceff1;
	overflow:auto; 
/* 	margin-right:-3px; */
}
.right { 
	float:right; 
	width:30px; 
 	height:100%;
/* 	background:#0f0; */
/* 	margin-left:-3px; */
}
.center { 
 	background:#333;
 	height:100%;
 	clear:none;
  	overflow:auto;
  	padding:0px;
  	margin:0px;
  	border:0px;
/* 	margin:0 100px;  */
/* 	margin:0 8px; */
}

#btnSearch:hover {
	background-color:#ffdb88;
}	

.logo-android {
	display: inline-block;
}

</style>

<script src="js/jquery/jquery-1.11.3.js"></script>
<script src="const.js"></script>
<script src="js/jquery.binarytransport.js"></script>
<script src="js/util.js"></script>

<script src="js-xlsx/iemagic.js"></script>
<script src="js-xlsx/shim.js"></script>
<script src="js-xlsx/jszip.js"></script>
<script src="js-xlsx/xlsx.js"></script>

<script>

// need to modify this path !!!
var FLY_FILE= "e:\\skyline\\怡德小区项目\\模型\\Skyline-TDJ0810\\Default.fly";

var sgworld = null;
var houseDb = []; // the associated xlsx data
var searchResult=[];

/**
 * return null if not found
 */
function getFirstObject() {
    // root is the first visible item in tree.
    var pt = sgworld.ProjectTree;
    var root1 = pt.GetNextItem("", ITEM_CODE.ROOT);
    if (root1 == "") {
        return null;
    }

    while(true) {
		var obj = pt.GetObject(root1);
		if(obj!=null) {
			return root1;
		}
		root1 = pt.GetNextItem(root1, ITEM_CODE.NEXT);
		if(root1=="") {
			break;
		}
	}
	return null;
}

// debug code, visit whole project tree.
function scanTree() {
    try {
        //alert("Click OK to find Vermont item by its path in the tree");
//         var id = sgworld.ProjectTree.FindItem("New England\\States\\Vermont");
//         if(id)
//             alert("Found Vermont with id=" + id);
//         else
//             alert("New England\\States\\Vermont does not exist in tree");


        // root is the first visible item in tree.
        var root = sgworld.ProjectTree.GetNextItem("", ITEM_CODE.ROOT);

        // if the tree have hidden group, skip it.

        // find hidden group by its name. We could also check by HiddenGroupID , which is actually its parent id.

        if(sgworld.ProjectTree.GetItemName(root) == sgworld.ProjectTree.HiddenGroupName) {
            root = sgworld.ProjectTree.GetNextItem(root, ITEM_CODE.NEXT);
        }

        var tree = buildTreeRecursive(root, 1);

        alert(tree);
    }
    catch (ex) {
       alert("Unexpected error: " + ex.description);
    }
}

function buildTreeRecursive(current, indent) {
    // build padding
    var padding = "";
    for (var i = 0; i < indent * 3; i++) {
        padding += "-"; 
    }
    var result = "";
    // iterate over all siblings of current node
    while (current) {
        // append node name to the tree string
        var currentName = sgworld.ProjectTree.GetItemName(current);
        var objData = sgworld.ProjectTree.GetObject(current);
        if(objData==null) {
        	objData = {ObjectType:'null'};
        }
       	result += padding + current + " " + currentName + " objType:" + objData.ObjectType + "";
       	if (objData.ObjectType==8) { // Box
       		result += " width: " + objData.Width;
       		result += " height: " + objData.Height;
       	}
       	result += "\r\n";
        
        // if current node is group, recursively build tree from its first child;
        if (sgworld.ProjectTree.IsGroup(current)) {
            var child = sgworld.ProjectTree.GetNextItem(current, ITEM_CODE.CHILD);
            result += buildTreeRecursive(child, indent + 1);
        }
        // move to next sibling
        current = sgworld.ProjectTree.GetNextItem(current, ITEM_CODE.NEXT);
    }
    return result;
}

/**
 * process xlsx workbook
 */
function processWb(workbook) {
	houseDb = [];

	workbook.SheetNames.forEach(function(sheetName) {
		var data = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
		if(data.length > 0){
			for(var i=0;i<data.length;i++) {
				if(data[i].skylineId!=null && data[i].skylineId!="") {
					houseDb.push(data[i]);
				}
			}
		}
	});
}

function readXslx() {
	var xlsxFilename = getXlsxFilename(FLY_FILE);
	//alert("xlsx filename: " + xlsxFilename);
	$.ajax({
		url: "xlsx/" + xlsxFilename,
		type: "GET",
		dataType: "binary",
		processData: false,
		success: function(data0){
			// do something with binary data
			var data = new Uint8Array(data0);
			console.log("data len: " + data.length);
			var arr = new Array();
			var zc = 0;
			for(var i = 0; i != data.length; ++i) {
				if(data[i]==0) {
					zc++;
				}
				arr[i] = String.fromCharCode(data[i]);
			}
			var wb = XLSX.read(arr.join(""), {type:"binary"});
			processWb(wb);
			//console.log("zc: " + zc);
			//alert("houseDb : " + houseDb.length);
		},
		failure: function() {
			alert("读取xlsx文件失败:");			
		}
	});	
}

function btnSearchOnClick() {
	var search = $("#eSearch").val();
	if(isEmpty(search)) {
		alert("请输入查询内容");
		return;
	}
	
	// replace whiteSpace --> *
	search = search.replace(new RegExp(" ","g"), "*");
	// replace *... --> .*
	search = search.replace(new RegExp("\\*+","g"), ".*");
	var re = new RegExp(search, "g");
	
	searchResult = [];
	$("#eResult").empty();
	
	var i;
	for(i=0;i<houseDb.length;i++) {
		var h = houseDb[i];
		if(re.test(h.buildingNo)) {
			searchResult.push(h);
		}
		else if(re.test(h.unit)) {
			searchResult.push(h);
		}
		else if(re.test(h.level)) {
			searchResult.push(h);
		}
		else if(re.test(h.houseNo)) {
			searchResult.push(h);
		}
		else if(re.test(h.holderName)) {
			searchResult.push(h);
		}
		else if(re.test(h.renterName)) {
			searchResult.push(h);
		}
		else if(re.test(h.houseType)) {
			searchResult.push(h);
		}
		else if(re.test(h.type)) {
			searchResult.push(h);
		}
		else if(re.test(h.buildingNo+h.houseNo)) {
			searchResult.push(h);
		}
	}
	
	if(searchResult.length<1) {
		alert("没有查到数据");
		return;
	}
	
	renderResultData(searchResult);
}


function dumpobj(obj) {
	var ret = "";
	for(var x in obj) {
		ret = ret + " " + x;
	}
	return ret;
}

/**
 * 点击搜索结果处理函数
 * idx - 为searchResult里面的index
 */
function gotoObject(idx) {
	if (searchResult[idx]==null) return;
	var data = searchResult[idx];
	var objId = sgworld.ProjectTree.FindItem(data.skylineId); // skylineId: 1号楼\201
	//debugger;
	if (objId!="") {		
		var obj = sgworld.ProjectTree.GetObject(objId);
		//alert("text: " + obj.Text);
		var ret = dumpobj(obj);
		var name = obj.Name;
		var x = obj.Message;
		var v;
		/*
		v = obj.ObjectType;
		v = obj.Message.MessageID;
		v = obj.Message.ObjectType;
		v = obj.Message.GetMessageObject().ObjectType;
		v= obj.Message.GetMessageObject().Text;
		*/
		
		//obj.Message.GetMessageObject().InnerText = "the text set in js....";

		//debugger;
		var msg = sgworld.Creator.CreatePopupMessage("msg", "", 10, 10, 450, 200, 9000);
		msg.InnerText = data.buildingNo + " " + data.unit + " " + data.holderName + " " ;
		obj.Message.MessageID = msg.ID;
		
		//obj.Text = "the text set in javascript ....";
		setTimeout(function() {
			sgworld.Navigate.FlyTo(objId,0);
		}, 300);
	}
}

function renderResultData(searchResult) {
	var tmp = 
	"<div onclick='gotoObject({idx});'> {title}" +
		//"<a onclick= />{title}</a>" + 
  	"</div>";
	
  	var data;
	for(i=0;i<searchResult.length;i++) {
		data = searchResult[i];
  		html = String.format2(tmp, {idx:i, title:data.houseNo});
  		//alert("html: " + html);
		$("#eResult").append(html);
	}
}


function onTerraExplorerMessage(messageId, senderNodeId)
{
	alert("on Message");
    var message = SGWorld.Creator.GetObject(messageId);
    var senderNode = SGWorld.Creator.GetObject(senderNodeId);
    senderNode.Text = message.Text;
}


function onload() {
	readXslx();
	
	$("#btnSearch").click(btnSearchOnClick);
    $('#eSearch').bind('keypress',function(event) {
        if(event.keyCode==VK_ENTER) {
            btnSearchOnClick();
        }
    });	
	
	try {
		sgworld = new ActiveXObject("TerraExplorerX.SGWorld66");
	}
	catch(e) {		
		alert("请安装TerraExplorer 6.6");
		return;
	}
	
	sgworld.IgnoreAccelerators = true;
	
	sgworld.AttachEvent("onTerraExplorerMessage", onTerraExplorerMessage);

	var te3dwin = document.getElementById("te3dwin");
	var c = te3dwin.Caption;
	//alert(c);	
		
	sgworld.Project.Open(FLY_FILE, false);
	
	// fly to first object
	var id = getFirstObject();

	if(id!=null) {
		// why FlyTo must run after some time ???
		setTimeout(function() {
			//alert("flyto: " + id);

			//var obj = sgworld.Creator.GetObject("0_620831");
			//obj.FillStyle.Color.FromHTMLColor("ff0000");
			
	        //var msg = sgworld.Creator.CreateMessage(0, "the text set in javascript....",0,true);
	        //obj.Message.MessageID = msg.ID;
	        //v = obj.Message.MessageID;
	        //sgworld.Project.Save();
	        
			sgworld.Navigate.FlyTo(id, 18); 
			//sgworld.Navigate.FlyTo(id,0);

	        // test code			
			//sgworld.AttachEvent("onTerraExplorerMessage", onTerraExplorerMessage);
			//var label = sgworld.Creator.CreateTextLabel(sgworld.Creator.CreatePosition(-71.00425, 42.36081, 100), 
		    //      "Click here to get the name of the airport",sgworld.Creator.CreateLabelStyle());

			//var msg = sgworld.Creator.CreateMessage(0, "Logan International",0);
		    //label.Message.MessageID = msg.ID;
		    //sgworld.Navigate.JumpTo(label);        	
			
			/*
			var ps = "";
			var p = sgworld.ProjectTree;
			for(var px in p ) {
				ps = ps + px + " ";
			}
			console.log("ps: " + ps);
			var x1 = p.FindItem("1号楼\\201");
			console.log("x1: " + p.GetItemName(x1));
			var x2 = p.FindItem("2号楼\\201");
			console.log("x2: " + p.GetItemName(x2));
			*/
			
		}, 1000);
	}
	
	//scanTree();
    //sgworld.Navigate.FlyTo("yide1",0);
}
</script>

</head>
<body onload="onload();">

<!-- this not work ! 
<object id="sgworld" classid="CLSID:3A4F9197-65A8-11D5-85C1-0001023952C1" style="visibility:hidden;height:0px;"></object> -->

<div id="dHead">

	<a class="logo-android" href="./">
    	<img alt="company logo" src="images/logo-android-green_1x.png">
  	</a>

	<div style="float:right;">
		<input id="eSearch"/>
		<img id="btnSearch" width="32px" height="32px" src="images/search.png"  style="vertical-align:middle;">
	</div>
</div>

<div id="dBody">
	
<div class="left">
	<div id="eResult" style="padding:10px;">
	</div>
</div>

<div class="right"></div>
<div class="center">

<!-- <div style="background:yellow;"> -->
<!-- 	toolbar 1 -->
<!-- </div> -->
<object id="te3dwin" classid="CLSID:3a4f9192-65a8-11d5-85c1-0001023952c1" width="99%" height="99%" style="border:0px;background:red;padding:0px;margin:0px;">
</object>
</div>
	
</div>

<div id="dFoot" style="padding:28px 36px;background:#b0bec5;color:#fff;display:block;box-sizing:border-box;">
	<div style="display:inline-block;box-sizing:border-box;">
		<p>
	    	<a href="https://www.google.com/intl/en_us/policies/" target="_blank">
	        	**某某某某某某某某公司
	        </a>
		</p>
	</div>
	    
	<ul style="float:right;margin:10px -10px;font-weight:300;font-size:16px;line-height:1.6;list-style:none;">
		<li>
	    	<a href="https://plus.google.com/+android/posts" target="_blank" title="Find Android on Google+" data-g-event="site-footer-social" data-g-action="clicked" data-g-label="g-plus">
	        	其他链接...
	        </a>
		</li>
	</ul>
</div>

</body>
</html>
