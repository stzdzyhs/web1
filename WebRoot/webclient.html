<!DOCTYPE HTML>
<html>
<head>
<title>Web Client</title>

<style>
html,body {
    height:100%;
    margin:0;
    padding:0
}

#dHead {
    height:100px;
/*     line-height:100px; */
    background:#690;
    width:100%;
    position:absolute;
/*     z-index:5; */
    top:0;
    box-sizing:border-box;
    padding:15px 35px 10px 15px;
/*     text-align:center; */
}
#dBody {
/*     background:#FC0; */
	display: flex;
  	flex-direction: row;

    width:100%;
	/*overflow:auto;*/ 
    overflow:hide; 
/*     z-index:10; */
    position:absolute;
    clear:none;
    top:100px;
    bottom:100px;
}
.mycontent {
    padding:20px;
    border:0px solid blue;
}
#dFoot {
    height:100px;
/*     line-height:100px; */
/*     background:red; */
    width:100%;
/*     z-index:200; */
    position:absolute;
    bottom:0;
/*     text-align:center; */
}

.left { 
/* 	float:left; */
	flex: 0 0 auto; 
 	/*display:block;*/
	width:300px;
 	height:100%;
	background:#eceff1;
	overflow:auto;
	padding:8px; 
/* 	margin-right:-3px; */
}
.right { 
	float:right; 
	width:30px; 
 	height:100%;
/* 	background:#0f0; */
/* 	margin-left:-3px; */
}
.center { 
 	background:#ccc;
 	height:100%;
/*  	display:block; */
/*  	clear:none; */
/*  	float:right; */
  	flex: 1 1 auto;
  	overflow:hidden;
  	padding:0px;
  	margin:0px;
  	border:0px;
/* 	margin:0 100px;  */
/* 	margin:0 8px; */
}

#btnSearch:hover {
	background-color:#ffdb88;
}	

.logo-android {
	display: inline-block;
}

</style>

<script src="js/jquery/jquery-1.11.3.js"></script>

<script type="text/javascript" src="js/jquery-resizable/jquery-resizable.js"></script>
<link rel="stylesheet" type="text/css" href="js/jquery-resizable/css/style.css">

<script src="const.js"></script>
<script src="js/jquery.binarytransport.js"></script>
<script src="js/util.js"></script>

<script src="js-xlsx/iemagic.js"></script>
<script src="js-xlsx/shim.js"></script>
<script src="js-xlsx/jszip.js"></script>
<script src="js-xlsx/xlsx.js"></script>

<script>

// need to modify this path !!!
//var FLY_FILE= "e:\\skyline\\怡德小区项目\\模型\\Skyline-TDJ0810\\Default.fly";
var FLY_FILE= "e:\\skyline\\怡德\\怡德1101\\Default1101.fly";


var sgworld = null;
var houseDb = []; // the associated xlsx data
var searchResult=[];

var selectBox = null;

/**
 * return null if not found
 */
function getFirstObject() {
    // root is the first visible item in tree.
    var pt = sgworld.ProjectTree;
    var root1 = pt.GetNextItem("", ITEM_CODE.ROOT);
    if (root1 == "") {
        return null;
    }

    while(true) {
		var obj = pt.GetObject(root1);
		if(obj!=null) {
			return root1;
		}
		root1 = pt.GetNextItem(root1, ITEM_CODE.NEXT);
		if(root1=="") {
			break;
		}
	}
	return null;
}

// debug code, visit whole project tree.
function scanTree() {
    try {
        //alert("Click OK to find Vermont item by its path in the tree");
//         var id = sgworld.ProjectTree.FindItem("New England\\States\\Vermont");
//         if(id)
//             alert("Found Vermont with id=" + id);
//         else
//             alert("New England\\States\\Vermont does not exist in tree");


        // root is the first visible item in tree.
        var root = sgworld.ProjectTree.GetNextItem("", ITEM_CODE.ROOT);

        // if the tree have hidden group, skip it.

        // find hidden group by its name. We could also check by HiddenGroupID , which is actually its parent id.

        if(sgworld.ProjectTree.GetItemName(root) == sgworld.ProjectTree.HiddenGroupName) {
            root = sgworld.ProjectTree.GetNextItem(root, ITEM_CODE.NEXT);
        }

        var tree = buildTreeRecursive(root, 1);

        alert(tree);
    }
    catch (ex) {
       alert("Unexpected error: " + ex.description);
    }
}

function buildTreeRecursive(current, indent) {
    // build padding
    var padding = "";
    for (var i = 0; i < indent * 3; i++) {
        padding += "-"; 
    }
    var result = "";
    // iterate over all siblings of current node
    while (current) {
        // append node name to the tree string
        var currentName = sgworld.ProjectTree.GetItemName(current);
        var objData = sgworld.ProjectTree.GetObject(current);
        if(objData==null) {
        	objData = {ObjectType:'null'};
        }
       	result += padding + current + " " + currentName + " objType:" + objData.ObjectType + "";
       	if (objData.ObjectType==8) { // Box
       		result += " width: " + objData.Width;
       		result += " height: " + objData.Height;
       	}
       	result += "\r\n";
        
        // if current node is group, recursively build tree from its first child;
        if (sgworld.ProjectTree.IsGroup(current)) {
            var child = sgworld.ProjectTree.GetNextItem(current, ITEM_CODE.CHILD);
            result += buildTreeRecursive(child, indent + 1);
        }
        // move to next sibling
        current = sgworld.ProjectTree.GetNextItem(current, ITEM_CODE.NEXT);
    }
    return result;
}

/**
 * process xlsx workbook
 */
function processWb(workbook) {
	houseDb = [];

	workbook.SheetNames.forEach(function(sheetName) {
		var data = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
		if(data.length > 0){
			for(var i=0;i<data.length;i++) {
				if(data[i].address!=null && data[i].address!="" &&  data[i].address!="住址") {
					houseDb.push(data[i]);
				}
			}
		}
	});
}

function readXslx() {
	var xlsxFilename = getXlsxFilename(FLY_FILE);
	//alert("xlsx filename: " + xlsxFilename);
	$.ajax({
		url: "xlsx/" + xlsxFilename,
		type: "GET",
		dataType: "binary",
		processData: false,
		success: function(data0){
			// do something with binary data
			var data = new Uint8Array(data0);
			console.log("data len: " + data.length);
			var arr = new Array();
			var zc = 0;
			for(var i = 0; i != data.length; ++i) {
				if(data[i]==0) {
					zc++;
				}
				arr[i] = String.fromCharCode(data[i]);
			}
			var wb = XLSX.read(arr.join(""), {type:"binary"});
			processWb(wb);
			//console.log("zc: " + zc);
			
			alert("houseDb : " + houseDb.length);
			for(i=0;i<houseDb.length;i++) {
				//console.log(i + " " + JSON.stringify(houseDb[i]));
			}
		},
		failure: function() {
			alert("读取xlsx文件失败:");			
		}
	});	
}

function btnSearchOnClick() {
	var search = $("#eSearch").val();
	if(isEmpty(search)) {
		alert("请输入查询内容");
		return;
	}
	
	// show left search result
	var w = parseInt($("#dvLeft").width(),10);
	if(w<100) {
		$("#dvLeft").animate({width:"300px"});
	}
	
	// replace whiteSpace --> *
	search = search.replace(new RegExp(" ","g"), "*");
	// replace *... --> .*
	search = search.replace(new RegExp("\\*+","g"), ".*");
	var re = new RegExp(search, "g");
	
	searchResult = [];
	$("#eResult").empty();
	
	var i;
	for(i=0;i<houseDb.length;i++) {
		var h = houseDb[i];	
		if(re.test(h.address)) {
			searchResult.push(h);
		}
		else if(re.test(h.houseAddress)) {
			searchResult.push(h);
		}
		else if(re.test(h.name)) {
			searchResult.push(h);
		}
		else if(search.length>7 && re.test(h.cid)) {// not test cid if too short
			searchResult.push(h);
		}
		else if(re.test(h.aid)) {
			searchResult.push(h);
		}
		else if(re.test(h.tel)) {
			searchResult.push(h);
		}
	}
	
	if(searchResult.length<1) {
		alert("没有查到数据");
		return;
	}
	
	renderResultData(searchResult);
}


function dumpobj(obj) {
	var ret = "";
	for(var x in obj) {
		ret = ret + " " + x;
	}
	return ret;
}

/**
 * 点击搜索结果处理函数
 * idx - 为searchResult里面的index
 */
function gotoObject(idx) {
	if (searchResult[idx]==null) return;
	var data = searchResult[idx];
	if(isEmpty(data.skylineId)) {
		alert("暂无3d数据");
		return;
	}
	
	var objId = sgworld.ProjectTree.FindItem(data.skylineId); // skylineId: 1号楼\201
	if(isEmpty(objId)) {
		alert("暂无3d数据:" + data.skylineId);
		return;
	}
	
	var obj = sgworld.ProjectTree.GetObject(objId);
	//alert("text: " + obj.Text);
	var ret = dumpobj(obj);
	var name = obj.Name;
	var x = obj.Message;
	var v;
	/*
	v = obj.ObjectType;
	v = obj.Message.MessageID;
	v = obj.Message.ObjectType;
	v = obj.Message.GetMessageObject().ObjectType;
	v= obj.Message.GetMessageObject().Text;
	*/
	
	//obj.Message.GetMessageObject().InnerText = "the text set in js....";

	//debugger;
	var msg = sgworld.Creator.CreatePopupMessage("msg", "", 10, 10, 450, 200, -1);
	msg.InnerText = data.address + "\r\n" + antiNull(data.houseAddress) + "\r\n" + data.name 
	    + " "  + antiNull(data.tel);
	obj.Message.MessageID = msg.ID;
	
    //设置高亮
    if(obj.ObjectType==ObjectType.OT_RECTANGLE) {
    	if (selectBox != null) {
        	selectBox.Terrain.Tint.SetAlpha(0);
        }
	    var nBGRValue1 = 0xff0000;
        obj.Terrain.Tint.FromBGRColor(nBGRValue1);
        obj.Terrain.Tint.SetAlpha(0.5);
		selectBox = obj;
    }
	
    var pos = sgworld.Creator.CreatePosition(obj.Position.X+0.00045, // X
    		obj.Position.Y, // Y
    		obj.Position.Altitude,     // Altitude
               0, //AltitudeTypeCode.ATC_TERRAIN_RELATIVE, // Altitude type
               obj.Position.Yaw,      // Yaw
               0);     // Pitch
	
	sgworld.Navigate.FlyTo(obj,0);
	
    setTimeout(function() {
    	sgworld.Navigate.SetPosition(pos);               
    }, 2000);
}

function renderResultData(searchResult) {
	var tmp =
"<div style='border-bottom:1px solid #888;overflow:hidden;padding:8px;' onclick='gotoObject({idx});'>" +
	"<div style='font-size:16px;'>{address}</div>" +
    "<div style='font-size:12px;'>{holder}</div>" +  
"</div>";		
		
  	var data;
	for(i=0;i<searchResult.length;i++) {
		data = searchResult[i];
  		html = String.format2(tmp, {idx:i, address:data.address, holder:data.name + " " + antiNull(data.tel) + " " + antiNull(data.skylineId) });
  		//alert("html: " + html);
		$("#eResult").append(html);
	}
}

/*
function onTerraExplorerMessage(messageId, senderNodeId) {
	alert("on Message");
    var message = SGWorld.Creator.GetObject(messageId);
    var senderNode = SGWorld.Creator.GetObject(senderNodeId);
    senderNode.Text = message.Text;
}
*/

function sgworld_OnLButtonDown(flags, x, y)
{
    var pIWorldPointInfo = sgworld.Window.PixelToWorld(x, y, WorldPointType.WPT_DEFAULT);
    var toid = pIWorldPointInfo.ObjectID;
    if (toid != null && toid != "")
    {
        if ((pIWorldPointInfo.Type == WorldPointType.WPT_PRIMITIVE))
        {
            if (selectBox != null)   //取消上一个高亮物体的高亮。
            {
                selectBox.Terrain.Tint.SetAlpha(0);
            }
            var pITerrainBox = sgworld.Creator.GetObject(toid);
            var nBGRValue1 = 0xff0000; //0x8080ff;
            pITerrainBox.Terrain.Tint.FromBGRColor(nBGRValue1);
            pITerrainBox.Terrain.Tint.SetAlpha(0.5);
            selectBox = pITerrainBox;
        }
    }
    return false; // 这里不能return true；否则导致不能浏览三维。
}



function onload() {
	readXslx();
	
	$("#btnSearch").click(btnSearchOnClick);
    $('#eSearch').bind('keypress',function(event) {
        if(event.keyCode==VK_ENTER) {
            btnSearchOnClick();
        }
    });	
	
	try {
		sgworld = new ActiveXObject("TerraExplorerX.SGWorld66");
	}
	catch(e) {		
		alert("请安装TerraExplorer 6.6");
		return;
	}
	
	sgworld.IgnoreAccelerators = true;
	
	//sgworld.AttachEvent("onTerraExplorerMessage", onTerraExplorerMessage);
	
	sgworld.AttachEvent("onLButtonDown", sgworld_OnLButtonDown);


	var te3dwin = document.getElementById("te3dwin");
	var c = te3dwin.Caption;
	//alert(c);	
		
	sgworld.Project.Open(FLY_FILE, false);
	
	// fly to first object
	var id = getFirstObject();

	if(id!=null) {
		// why FlyTo must run after some time ???
		setTimeout(function() {
			//alert("flyto: " + id);

			//var obj = sgworld.Creator.GetObject("0_620831");
			//obj.FillStyle.Color.FromHTMLColor("ff0000");
			
	        //var msg = sgworld.Creator.CreateMessage(0, "the text set in javascript....",0,true);
	        //obj.Message.MessageID = msg.ID;
	        //v = obj.Message.MessageID;
	        //sgworld.Project.Save();
	        
			sgworld.Navigate.FlyTo(id, 18); 
			//sgworld.Navigate.FlyTo(id,0);

	        // test code			
			//sgworld.AttachEvent("onTerraExplorerMessage", onTerraExplorerMessage);
			//var label = sgworld.Creator.CreateTextLabel(sgworld.Creator.CreatePosition(-71.00425, 42.36081, 100), 
		    //      "Click here to get the name of the airport",sgworld.Creator.CreateLabelStyle());

			//var msg = sgworld.Creator.CreateMessage(0, "Logan International",0);
		    //label.Message.MessageID = msg.ID;
		    //sgworld.Navigate.JumpTo(label);        	
			
			/*
			var ps = "";
			var p = sgworld.ProjectTree;
			for(var px in p ) {
				ps = ps + px + " ";
			}
			console.log("ps: " + ps);
			var x1 = p.FindItem("1号楼\\201");
			console.log("x1: " + p.GetItemName(x1));
			var x2 = p.FindItem("2号楼\\201");
			console.log("x2: " + p.GetItemName(x2));
			*/
			
		}, 1000);
	}
	
	//scanTree();
    //sgworld.Navigate.FlyTo("yide1",0);
}


$(document).ready(function() {
	$("#dvLeft").resizable({
		handleSelector: ".splitter",
		resizeHeight: false,
		onDrag:function(e, $el, newWidth, newHeight, opt) {
			//console.log("e " + JSON.stringify(e));
			//console.log("el : " + JSON.stringify($el));
			//console.log("new widht: " + newWidth);
			//console.log("newHeight : " + newHeight);
			//console.log("opt : " + JSON.stringify(opt) + " win width:" + window.innerWidth);
			// max: 300 px
			if(newWidth>400) {
				return false;
			}
			return true;
		}   
	});
	
	$("#splitter1").dblclick(function() {
		var w = parseInt($("#dvLeft").width(),10);
		if(w<100) {
			$("#dvLeft").animate({width:"300px"});
		}
		else {
			$("#dvLeft").animate({width:"0px"});
		}
	});
	
	onload();	
});
</script>

</head>
<body>

<!-- this not work ! 
<object id="sgworld" classid="CLSID:3A4F9197-65A8-11D5-85C1-0001023952C1" style="visibility:hidden;height:0px;"></object> -->

<div id="dHead">
	<a class="logo-android" href="./">
    	<img alt="company logo" src="images/logo-android-green_1x.png">
  	</a>

	<div style="float:right;">
		<input id="eSearch" size="30"/>
		<img id="btnSearch" width="32px" height="32px" src="images/search.png"  style="vertical-align:middle;">
	</div>
</div>

<div id="dBody">
	<div id="dvLeft" class="left">
		<div id="eResult" style="padding:5px;">
			<h2>搜索结果</h2>
		</div>
		
		<!-- 
		<div style='border-bottom:1px solid #888;overflow:hidden;padding:8px;' onclick='gotoObject({idx});'>
			<div style="font-size:16px;">address111...1111111111111111</div>
			<div style="font-size:12px;">名字 13925031491...</div> 
	  	</div>
		<div style='border-bottom:1px solid #888;overflow:hidden;padding:8px;' onclick='gotoObject({idx});'>
			<div style="font-size:16px;">address2222222222222222222222</div>
			<div style="font-size:12px;">名字 13925031491...</div> 
	  	</div>
 		-->	  	
	  			
	</div>
	<div id="splitter1" class="splitter">
    </div>
	<div id="dvCenter" class="center">
		<!-- <div style="background:yellow;"> -->
		<!-- 	toolbar 1 -->
		<!-- </div> -->
		<object id="te3dwin" classid="CLSID:3a4f9192-65a8-11d5-85c1-0001023952c1" width="100%" height="100%" style="box-sizing:border-box;border:gray solid 1px;padding:0px;margin:0px;">
		</object>
	</div>
</div>

<div id="dFoot" style="padding:28px 36px;background:#b0bec5;color:#fff;display:block;box-sizing:border-box;">
	<div style="display:inline-block;box-sizing:border-box;">
		<p>
	    	<a href="https://www.google.com/intl/en_us/policies/" target="_blank">
	        	**某某某某某某某某公司
	        </a>
		</p>
	</div>
	    
	<ul style="float:right;margin:10px -10px;font-weight:300;font-size:16px;line-height:1.6;list-style:none;">
		<li>
	    	<a href="https://plus.google.com/+android/posts" target="_blank" title="Find Android on Google+" data-g-event="site-footer-social" data-g-action="clicked" data-g-label="g-plus">
	        	其他链接...
	        </a>
		</li>
	</ul>
</div>

</body>
</html>
